input {
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse the timestamp correctly
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Decode base64 encoded ESLint log
  if [eslint_log_b64] {
    ruby {
      code => "
        require 'base64'
        event.set('eslint_log', Base64.decode64(event.get('eslint_log_b64')))
      "
    }
  }

  # Decode base64 encoded Test log
  if [test_log_b64] {
    ruby {
      code => "
        require 'base64'
        event.set('test_log', Base64.decode64(event.get('test_log_b64')))
      "
    }
  }

  # Decode base64 encoded Audit log (if exists)
  if [audit_log_b64] and ![audit_log_b64].empty? {
    ruby {
      code => "
        require 'base64'
        event.set('audit_log', Base64.decode64(event.get('audit_log_b64')))
      "
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "manual-logs-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug
  }
}