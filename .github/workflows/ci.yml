name: CI - Lint, Test, Security & Ship Logs

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint-test-security-log:
    name: Lint, Test, Scan & Ship Logs
    runs-on: ubuntu-latest

services:
  mysql:
    image: mysql:8.0
    env:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: book_management
    ports:
      - 3306:3306
    options: >
      --health-cmd="mysqladmin ping -uroot -proot --silent" \
      --health-interval=10s \
      --health-timeout=5s \
      --health-retries=5

steps:
  - name: ğŸ“‚ Checkout code
    uses: actions/checkout@v3

  - name: ğŸ§  Set up Node.js
    uses: actions/setup-node@v3
    with:
      node-version: '18'

  - name: ğŸ’¼ Install dependencies
    run: npm install

  - name: ğŸ”§ Wait for MySQL
    run: |
      until mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; do
        echo "Waiting for MySQL..." && sleep 3;
      done

  - name: ğŸš€ Run Migrations
    env:
      DB_USERNAME: root
      DB_PASSWORD: root
      DB_NAME: book_management
      DB_HOST: 127.0.0.1
    run: npx sequelize-cli db:migrate --env test

  - name: âœ¨ Run ESLint
    continue-on-error: true
    run: npm run lint | tee eslint-log.txt

  - name: ğŸ“Š Run Unit Tests
    env:
      DB_USERNAME: root
      DB_PASSWORD: root
      DB_NAME: book_management
      DB_HOST: 127.0.0.1
    run: npm test | tee test-log.txt

  - name: ğŸ” Run npm audit for vulnerability scan
    run: npm audit --audit-level=high || true | tee audit-log.txt

  - name: ğŸ›¡ï¸ Run OWASP Dependency Check
    uses: dependency-check/Dependency-Check_Action@main
    with:
      project: "book-management-api"
      format: "HTML"
      out: "reports"

  - name: ğŸ“¤ Upload OWASP Report
    uses: actions/upload-artifact@v4
    with:
      name: dependency-check-report
      path: reports

  - name: ğŸš€ Ship logs to Logstash
    env:
      LOGSTASH_URL: ${{ secrets.LOGSTASH_URL }}
    run: |
      curl -X POST "$LOGSTASH_URL" -H "Content-Type: application/json" -d @<(jq -n --arg lint "$(cat eslint-log.txt)" --arg test "$(cat test-log.txt)" --arg audit "$(cat audit-log.txt)" '{lint_log: $lint, test_log: $test, audit_log: $audit, timestamp: now | todate}')

